<% layout("/layouts/boilerplate.ejs") %>

<div class="container mt-5" data-aos="fade-right">
  <h2 class="mb-4">
    My <span class="samarkan-font text-danger-emphasis">Review</span>
  </h2>

  <% if (!user.userReview || user.userReview.length === 0) { %>
    <div class="col-8 offset-2">
      <div class="alert alert-info text-center">
        <h5>No reviews yet!</h5>
        <p>
          You haven't written any reviews yet.
          <a href="/listing">Browse Nivaas</a> to get started.
        </p>
      </div>
    </div>
  <% } else { %>

  <!-- ================= REVIEW GRID ================= -->
  <div class="row g-4">
    <% user.userReview.forEach(review => { if(review.listing){ %>

    <div class="col-12 col-md-6">

      <!-- ================= SINGLE CARD (FIXED) ================= -->
      <div class="card h-100">

        <!-- IMAGE -->
        <img
          src="<%= review.listing.image %>"
          class="card-img-top"
          alt="<%= review.listing.title %>"
          style="height:220px; object-fit:cover;"
        />

        <!-- BODY -->
        <div class="card-body d-flex justify-content-between gap-3">

          <!-- LEFT CONTENT -->
          <div>
            <h5 class="mb-1">
              <a
                href="/listing/<%= review.listing._id %>/show"
                class="text-decoration-none"
              >
                <%= review.listing.title %>
              </a>
            </h5>

            <p class="mb-1">
              <strong>â‚¹<%= review.listing.price.toLocaleString("en-IN") %></strong>/Night
            </p>

            <small class="text-muted d-block mb-2">
              <i class="fas fa-map-marker-alt"></i>
              <%= review.listing.location %>
            </small>

            <hr class="my-2">

            <h6>Your Review</h6>

            <div class="mb-2">
              <% for(let i=1;i<=5;i++){ %>
                <% if(i <= review.rating){ %>
                  <i class="fas fa-star text-warning"></i>
                <% } else { %>
                  <i class="far fa-star text-muted"></i>
                <% } %>
              <% } %>
              <span class="text-muted">(<%= review.rating %>/5)</span>
            </div>

            <p class="mb-1"><%= review.comment %></p>

            <small class="text-muted">
              <i class="fas fa-clock"></i>
              <%= review.createdAt.toDateString() %>
            </small>
          </div>

          <!-- RIGHT BUTTONS (VERTICAL + FIXED) -->
          <div class="btn-group-vertical align-self-center">
            <button
              type="button"
              class="btn btn-sm btn-outline-primary mb-2"
              data-bs-toggle="modal"
              data-bs-target="#editModal-<%= review._id %>"
              onclick="event.stopPropagation()"
            >
              Edit
            </button>

            <button
              type="button"
              class="btn btn-sm btn-outline-danger"
              data-bs-toggle="modal"
              data-bs-target="#deleteModal-<%= review._id %>"
              onclick="event.stopPropagation()"
            >
              Delete
            </button>
          </div>

        </div>
      </div>
      <!-- ================= END CARD ================= -->

    </div>

    <% }}) %>
  </div>
  <% } %>
</div>

<!-- ================= MODALS (OUTSIDE CONTAINER) ================= -->

<% if (user.userReview) { user.userReview.forEach(review => { if(review.listing){ %>

<!-- EDIT MODAL -->
<div class="modal fade" id="editModal-<%= review._id %>" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5>Edit Review</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form
        action="/listing/<%= review.listing._id %>/review/<%= review._id %>?_method=PUT"
        method="POST"
      >
        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">Rating</label>
            <select class="form-select" name="rating" required>
              <% for(let i=1;i<=5;i++){ %>
                <option value="<%= i %>" <%= i === review.rating ? "selected" : "" %>>
                  <%= i %> Stars
                </option>
              <% } %>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Comment</label>
            <textarea class="form-control" name="comment" rows="3" required><%= review.comment %></textarea>
          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary">Update</button>
        </div>
      </form>

    </div>
  </div>
</div>

<!-- DELETE MODAL -->
<div class="modal fade" id="deleteModal-<%= review._id %>" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5>Delete Review</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p>Are you sure?</p>
        <div class="alert alert-warning">
          <strong>Rating:</strong> <%= review.rating %>/5<br>
          <strong>Comment:</strong> <%= review.comment %>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

        <form
          action="/listing/<%= review.listing._id %>/review/<%= review._id %>?_method=DELETE"
          method="POST"
        >
          <button class="btn btn-danger">Delete</button>
        </form>
      </div>

    </div>
  </div>
</div>

<% }}) %>
<% } %>